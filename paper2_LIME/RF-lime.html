<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LIME paper: Random Forest for Solubility Prediciton &mdash; exmol  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="LIME paper: Recurrent Neural Network for Solubility Prediciton" href="Solubility-RNN.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../toc.html" class="icon icon-home"> exmol
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="Tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../paper1_CFs/Schematic.html">MMACE Paper: Counterfactual Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../paper1_CFs/RF.html">MMACE Paper: Random Forest for Blood-Brain Barrier</a></li>
<li class="toctree-l1"><a class="reference internal" href="../paper1_CFs/GNN.html">MMACE Paper: Graph Neural Network for HIV Inhibition</a></li>
<li class="toctree-l1"><a class="reference internal" href="../paper1_CFs/Solubility-RNN.html">MMACE Paper: Recurrent Neural Network for Predicting Solubility</a></li>
<li class="toctree-l1"><a class="reference internal" href="Solubility-RNN.html">LIME paper: Recurrent Neural Network for Solubility Prediciton</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">LIME paper: Random Forest for Solubility Prediciton</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#import-packages">Import packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="#build-and-train-a-random-forest-model">Build and train a Random Forest model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#compute-descriptor-attributions">Compute descriptor attributions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#do-we-recover-training-features">Do we recover training features?</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../toc.html">exmol</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../toc.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">LIME paper: Random Forest for Solubility Prediciton</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/ur-whitelab/exmol/blob/main/docs/source/paper2_LIME/RF-lime.ipynb" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="lime-paper-random-forest-for-solubility-prediciton">
<h1>LIME paper: Random Forest for Solubility Prediciton<a class="headerlink" href="#lime-paper-random-forest-for-solubility-prediciton" title="Permalink to this heading"></a></h1>
<section id="import-packages">
<h2>Import packages<a class="headerlink" href="#import-packages" title="Permalink to this heading"></a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import pandas as pd
import matplotlib.pyplot as plt

# import seaborn as sns
import matplotlib as mpl
import rdkit, rdkit.Chem, rdkit.Chem.Draw
from rdkit.Chem.Draw import IPythonConsole
import numpy as np
import mordred, mordred.descriptors
from mordred import HydrogenBond, Polarizability
from mordred import SLogP, AcidBase, BertzCT, Aromatic, BondCount, AtomCount
from mordred import Calculator

import exmol as exmol
from rdkit.Chem.Draw import rdDepictor
import os
from sklearn.ensemble import RandomForestRegressor
from sklearn.model_selection import train_test_split
from sklearn.metrics import roc_auc_score, plot_roc_curve

os.environ[&quot;CUDA_VISIBLE_DEVICES&quot;] = &quot;0&quot;
rdDepictor.SetPreferCoordGen(True)

IPythonConsole.ipython_useSVG = True
color_cycle = [&quot;#F06060&quot;, &quot;#1BBC9B&quot;, &quot;#F3B562&quot;, &quot;#6e5687&quot;, &quot;#5C4B51&quot;]
mpl.rcParams[&quot;axes.prop_cycle&quot;] = mpl.cycler(color=color_cycle)
np.random.seed(0)
soldata = pd.read_csv(
    &quot;https://github.com/whitead/dmol-book/raw/master/data/curated-solubility-dataset.csv&quot;
)
features_start_at = list(soldata.columns).index(&quot;MolWt&quot;)
</pre></div>
</div>
</div>
</div>
</section>
<section id="build-and-train-a-random-forest-model">
<h2>Build and train a Random Forest model<a class="headerlink" href="#build-and-train-a-random-forest-model" title="Permalink to this heading"></a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># make object that can compute descriptors
calc = Calculator()
calc.register([HydrogenBond.HBondDonor, HydrogenBond.HBondAcceptor])
calc.register(
    [AcidBase.AcidicGroupCount, AcidBase.BasicGroupCount, Aromatic.AromaticBondsCount]
)
calc.register([SLogP.SLogP, Polarizability.APol])
calc.register(
    [
        BondCount.BondCount(type=&quot;double&quot;),
        BondCount.BondCount(type=&quot;aromatic&quot;),
        AtomCount.AtomCount(&quot;Hetero&quot;),
    ]
)

# make subsample from pandas df
molecules = [rdkit.Chem.MolFromSmiles(smi) for smi in soldata.SMILES]

raw_features = []
for e, c in zip(molecules, calc.map(molecules, quiet=True)):
    raw_features.append([v for v in c.values()])
feature_names = np.array([d.description() for d in calc.descriptors])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>raw_features = np.array(raw_features)
labels = soldata[&quot;Solubility&quot;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def pick_features(raw_features):
    fm = raw_features.mean()
    fs = raw_features.std()

    def feature_convert(f):
        f -= fm
        f /= fs
        return f

    features = feature_convert(raw_features)

    # we have some nans in features, likely because std was 0
    features = features.astype(float)
    features_select = np.random.randint(
        0, len(raw_features[0]), size=3
    )  # np.all(np.isfinite(features), axis=0)
    features = features[:, features_select]
    names = feature_names[features_select]
    return features, names
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>features, names = pick_features(raw_features)
print(features.shape, names)

X_train, X_test, y_train, y_test = train_test_split(
    features, labels, test_size=0.1, shuffle=True
)

clf = RandomForestRegressor(max_depth=10, random_state=0)
clf.fit(X_train, y_train)
predicted = clf.predict(X_test)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(9982, 3) [&#39;Wildman-Crippen LogP&#39; &#39;number of hydrogen bond donor&#39;
 &#39;basic group count&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plt.figure(figsize=(5, 4))
plt.plot(y_test, predicted, &quot;.&quot;)
plt.plot(y_test, y_test, linestyle=&quot;:&quot;)
plt.text(
    max(y_test) - 6,
    min(y_test) + 1,
    f&quot;correlation = {np.corrcoef(y_test, predicted)[0,1]:.3f}&quot;,
    fontsize=12,
)
plt.text(
    max(y_test) - 6,
    min(y_test),
    f&quot;loss = {np.sqrt(np.mean((y_test - predicted)**2)):.3f}&quot;,
    fontsize=12,
)
plt.savefig(&quot;RF-ROC.png&quot;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/2e1195ba8a8e415f462b800a6a5ef704509f6373cdd3936824831d122d8b84c4.png" src="../_images/2e1195ba8a8e415f462b800a6a5ef704509f6373cdd3936824831d122d8b84c4.png" />
</div>
</div>
</section>
<section id="compute-descriptor-attributions">
<h2>Compute descriptor attributions<a class="headerlink" href="#compute-descriptor-attributions" title="Permalink to this heading"></a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def model_eval(smiles):
    molecules = [rdkit.Chem.MolFromSmiles(smi) for smi in smiles]
    labels = clf.predict(np.nan_to_num(features))
    return labels


labels = model_eval(soldata.SMILES)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>smi = soldata.SMILES[1500]
stoned_kwargs = {
    &quot;num_samples&quot;: 2000,
    &quot;alphabet&quot;: exmol.get_basic_alphabet(),
    &quot;max_mutations&quot;: 2,
}
space = exmol.sample_space(smi, model_eval, stoned_kwargs=stoned_kwargs, quiet=True)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def calc_feature_importance(descriptors, tstats):
    from collections import OrderedDict

    feature_importance = {a: b for a, b in zip(descriptors, tstats) if not np.isnan(b)}
    feature_importance = dict(
        sorted(feature_importance.items(), key=lambda item: abs(item[1]), reverse=True)
    )
    # Fitted space important features
    return feature_importance
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>descriptor_type = &quot;Classic&quot;
exmol.lime_explain(space, descriptor_type=descriptor_type)
wls_attr = calc_feature_importance(
    list(space[0].descriptors.descriptor_names), list(space[0].descriptors.tstats)
)
wls_attr
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;number of heteroatoms&#39;: 2.005639250403021,
 &#39;acidic group count&#39;: 1.7178494920326794,
 &#39;atomic polarizability&#39;: -1.6519164000027657,
 &#39;Wildman-Crippen LogP&#39;: 1.267846013204191,
 &#39;number of hydrogen bond acceptor&#39;: -1.1504129562775953,
 &#39;basic group count&#39;: -0.9129639743522328,
 &#39;number of hydrogen bond donor&#39;: -0.34274599286467194,
 &#39;ring count&#39;: 0.32799733404574416,
 &#39;aromatic bonds count&#39;: 0.18091037688652478,
 &#39;number of rotatable bonds&#39;: 0.04327099645711095}
</pre></div>
</div>
</div>
</div>
</section>
<section id="do-we-recover-training-features">
<h2>Do we recover training features?<a class="headerlink" href="#do-we-recover-training-features" title="Permalink to this heading"></a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>x = wls_attr.keys()
xaxis = np.arange(len(x))
x_colors = [&quot;purple&quot; if t in names else &quot;black&quot; for t in x]

rf_imp = {a: b for a, b in zip(names, clf.feature_importances_)}
rf_x = np.zeros(len(x))
rf_y = np.zeros(len(x))
for i, j in enumerate(x):
    if j in rf_imp:
        rf_x[i] = i
        rf_y[i] = rf_imp[j]

width = [wls_attr[i] for i in x]
colors = [&quot;#F06060&quot; if i &lt; 0 else &quot;#1BBC9B&quot; for i in width]

fig, ax = plt.subplots(figsize=(6, 5))
ax.barh(xaxis + 0.2, width, 0.75, label=&quot;WLS&quot;, color=colors)

plt.xticks(fontsize=12)
plt.xlabel(&quot;Feature t-statistics&quot;, fontsize=12)
plt.yticks(xaxis, x, fontsize=12)
[t.set_color(i) for (i, t) in zip(x_colors, ax.yaxis.get_ticklabels())]
plt.gca().invert_yaxis()
plt.title(&quot;Random Forest Regression&quot;, fontsize=12)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Random Forest Regression&#39;)
</pre></div>
</div>
<img alt="../_images/0953e30be606142c276118b6158efeba56a0b56236d5655d0ee9dd2e82077840.png" src="../_images/0953e30be606142c276118b6158efeba56a0b56236d5655d0ee9dd2e82077840.png" />
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Solubility-RNN.html" class="btn btn-neutral float-left" title="LIME paper: Recurrent Neural Network for Solubility Prediciton" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Geemi Wellawatte, Andrew D White.
      <span class="lastupdated">Last updated on True.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>