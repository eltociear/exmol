<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MMACE Paper: Graph Neural Network for HIV Inhibition &mdash; exmol  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="MMACE Paper: Recurrent Neural Network for Predicting Solubility" href="Solubility-RNN.html" />
    <link rel="prev" title="MMACE Paper: Random Forest for Blood-Brain Barrier" href="RF.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../toc.html" class="icon icon-home"> exmol
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../paper2_LIME/Tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="Schematic.html">MMACE Paper: Counterfactual Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="RF.html">MMACE Paper: Random Forest for Blood-Brain Barrier</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">MMACE Paper: Graph Neural Network for HIV Inhibition</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#cf-explanation">CF explanation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Solubility-RNN.html">MMACE Paper: Recurrent Neural Network for Predicting Solubility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../paper2_LIME/Solubility-RNN.html">LIME paper: Recurrent Neural Network for Solubility Prediciton</a></li>
<li class="toctree-l1"><a class="reference internal" href="../paper2_LIME/RF-lime.html">LIME paper: Random Forest for Solubility Prediciton</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../toc.html">exmol</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../toc.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">MMACE Paper: Graph Neural Network for HIV Inhibition</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/ur-whitelab/exmol/blob/main/docs/source/paper1_CFs/GNN.ipynb" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="mmace-paper-graph-neural-network-for-hiv-inhibition">
<h1>MMACE Paper: Graph Neural Network for HIV Inhibition<a class="headerlink" href="#mmace-paper-graph-neural-network-for-hiv-inhibition" title="Permalink to this heading">ÔÉÅ</a></h1>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># import os
# os.environ[&quot;CUDA_VISIBLE_DEVICES&quot;] = &quot;2&quot;
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import matplotlib as mpl
import numpy as np
import tensorflow as tf
import selfies as sf
import exmol
import skunk
import warnings
from rdkit import Chem
from rdkit.Chem.Draw import rdDepictor

rdDepictor.SetPreferCoordGen(True)
from rdkit.Chem.Draw import IPythonConsole

IPythonConsole.ipython_useSVG = True
sns.set_context(&quot;notebook&quot;)
sns.set_style(
    &quot;dark&quot;,
    {
        &quot;xtick.bottom&quot;: True,
        &quot;ytick.left&quot;: True,
        &quot;xtick.color&quot;: &quot;#666666&quot;,
        &quot;ytick.color&quot;: &quot;#666666&quot;,
        &quot;axes.edgecolor&quot;: &quot;#666666&quot;,
        &quot;axes.linewidth&quot;: 0.8,
        &quot;figure.dpi&quot;: 300,
    },
)
color_cycle = [&quot;#1BBC9B&quot;, &quot;#F06060&quot;, &quot;#F3B562&quot;, &quot;#6e5687&quot;, &quot;#5C4B51&quot;]
mpl.rcParams[&quot;axes.prop_cycle&quot;] = mpl.cycler(color=color_cycle)
np.random.seed(0)
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-12-07 21:11:45.445605: I tensorflow/core/platform/cpu_feature_guard.cc:193] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 FMA
To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.
2022-12-07 21:11:45.604833: W tensorflow/compiler/xla/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libcudart.so.11.0&#39;; dlerror: libcudart.so.11.0: cannot open shared object file: No such file or directory; LD_LIBRARY_PATH: /opt/hostedtoolcache/Python/3.8.15/x64/lib
2022-12-07 21:11:45.604862: I tensorflow/compiler/xla/stream_executor/cuda/cudart_stub.cc:29] Ignore above cudart dlerror if you do not have a GPU set up on your machine.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-12-07 21:11:46.668481: W tensorflow/compiler/xla/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libnvinfer.so.7&#39;; dlerror: libnvinfer.so.7: cannot open shared object file: No such file or directory; LD_LIBRARY_PATH: /opt/hostedtoolcache/Python/3.8.15/x64/lib
2022-12-07 21:11:46.668641: W tensorflow/compiler/xla/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libnvinfer_plugin.so.7&#39;; dlerror: libnvinfer_plugin.so.7: cannot open shared object file: No such file or directory; LD_LIBRARY_PATH: /opt/hostedtoolcache/Python/3.8.15/x64/lib
2022-12-07 21:11:46.668655: W tensorflow/compiler/tf2tensorrt/utils/py_utils.cc:38] TF-TRT Warning: Cannot dlopen some TensorRT libraries. If you would like to use Nvidia GPU with TensorRT, please make sure the missing libraries mentioned above are installed properly.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># shuffle rows and sample fom HIV dataset
hivdata = pd.read_csv(&quot;HIV.csv&quot;)
# REDUCED Data FOR CI
hivdata = hivdata.sample(frac=0.1).reset_index(drop=True)
hivdata.head()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>smiles</th>
      <th>activity</th>
      <th>HIV_active</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>COc1ccc2c(c1)OCC1(C)c3cc(O)c(OCc4ccccc4)cc3OC21</td>
      <td>CI</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Cc1cc(-c2ccc(Cl)cc2)c(C#N)c(=S)n1C1OC(CO)C(O)C...</td>
      <td>CI</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>CNn1c(-c2ccccc2)n[nH]c1=O</td>
      <td>CM</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>O=NN(CCCl)C(=O)NC1CCCCC1</td>
      <td>CI</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>C=C1CCC(C)(c2ccc(CO)cc2)C1C</td>
      <td>CI</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def gen_smiles2graph(sml):
    &quot;&quot;&quot;Argument for the RD2NX function should be a valid SMILES sequence
    returns: the graph
    &quot;&quot;&quot;
    m, smi_canon, status = exmol.stoned.sanitize_smiles(sml)
    # m = Chem.MolFromSmiles(smi_canon)
    m = Chem.AddHs(m)
    order_string = {
        Chem.rdchem.BondType.SINGLE: 1,
        Chem.rdchem.BondType.DOUBLE: 2,
        Chem.rdchem.BondType.TRIPLE: 3,
        Chem.rdchem.BondType.AROMATIC: 4,
    }
    N = len(list(m.GetAtoms()))
    # nodes = np.zeros((N,100))
    nodes = np.zeros((440, 100))
    for i in m.GetAtoms():
        nodes[i.GetIdx(), i.GetAtomicNum()] = 1

    # adj = np.zeros((N,N))
    adj = np.zeros((440, 440))
    for j in m.GetBonds():
        u = min(j.GetBeginAtomIdx(), j.GetEndAtomIdx())
        v = max(j.GetBeginAtomIdx(), j.GetEndAtomIdx())
        order = j.GetBondType()
        if order in order_string:
            order = order_string[order]
        else:
            raise Warning(&quot;Ignoring bond order&quot; + order)
        adj[u, v] = 1
        adj[v, u] = 1
    adj += np.eye(440)
    return nodes, adj
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>class GCNLayer(tf.keras.layers.Layer):
    &quot;&quot;&quot;Implementation of GCN as layer&quot;&quot;&quot;

    def __init__(self, activation=None, **kwargs):
        # constructor, which just calls super constructor
        # and turns requested activation into a callable function
        super(GCNLayer, self).__init__(**kwargs)
        self.activation = tf.keras.activations.get(activation)

    def build(self, input_shape):
        # create trainable weights
        node_shape, adj_shape = input_shape
        self.w = self.add_weight(shape=(node_shape[2], node_shape[2]), name=&quot;w&quot;)

    def call(self, inputs):
        # split input into nodes, adj
        nodes, adj = inputs
        # compute degree
        degree = tf.reduce_sum(adj, axis=-1)
        # GCN equation
        new_nodes = tf.einsum(&quot;bi,bij,bjk,kl-&gt;bil&quot;, 1 / degree, adj, nodes, self.w)
        out = self.activation(new_nodes)
        return out, adj
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>class GRLayer(tf.keras.layers.Layer):
    &quot;&quot;&quot;Reduction layer: A GNN layer that computes average over all node features&quot;&quot;&quot;

    def __init__(self, name=&quot;GRLayer&quot;, **kwargs):
        super(GRLayer, self).__init__(name=name, **kwargs)

    def call(self, inputs):
        nodes, adj = inputs
        reduction = tf.reduce_mean(nodes, axis=1)
        return reduction
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ninput = tf.keras.Input(
    (
        None,
        100,
    )
)
ainput = tf.keras.Input(
    (
        None,
        None,
    )
)
# GCN block
x = GCNLayer(&quot;relu&quot;)([ninput, ainput])
x = GCNLayer(&quot;relu&quot;)(x)
x = GCNLayer(&quot;relu&quot;)(x)
x = GCNLayer(&quot;relu&quot;)(x)
# reduce to graph features
x = GRLayer()(x)
# standard layers
x = tf.keras.layers.Dense(256)(x)
x = tf.keras.layers.Dense(1, activation=&quot;sigmoid&quot;)(x)
gcnmodel = tf.keras.Model(inputs=(ninput, ainput), outputs=x)
gcnmodel.compile(
    &quot;adam&quot;,
    loss=tf.keras.losses.BinaryCrossentropy(from_logits=False),
    metrics=[&quot;accuracy&quot;],
)
gcnmodel.summary()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-12-07 21:11:48.042919: W tensorflow/compiler/xla/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libcuda.so.1&#39;; dlerror: libcuda.so.1: cannot open shared object file: No such file or directory; LD_LIBRARY_PATH: /opt/hostedtoolcache/Python/3.8.15/x64/lib
2022-12-07 21:11:48.042962: W tensorflow/compiler/xla/stream_executor/cuda/cuda_driver.cc:265] failed call to cuInit: UNKNOWN ERROR (303)
2022-12-07 21:11:48.042994: I tensorflow/compiler/xla/stream_executor/cuda/cuda_diagnostics.cc:156] kernel driver does not appear to be running on this host (fv-az210-556): /proc/driver/nvidia/version does not exist
2022-12-07 21:11:48.043236: I tensorflow/core/platform/cpu_feature_guard.cc:193] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 FMA
To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;model&quot;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>__________________________________________________________________________________________________
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> Layer (type)                   Output Shape         Param #     Connected to                     
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>==================================================================================================
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> input_1 (InputLayer)           [(None, None, 100)]  0           []                               
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                                                                                  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> input_2 (InputLayer)           [(None, None, None)  0           []                               
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                ]                                                                 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                                                                                  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> gcn_layer (GCNLayer)           ((None, None, 100),  10000       [&#39;input_1[0][0]&#39;,                
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                 (None, None, None)               &#39;input_2[0][0]&#39;]                
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                )                                                                 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                                                                                  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> gcn_layer_1 (GCNLayer)         ((None, None, 100),  10000       [&#39;gcn_layer[0][0]&#39;,              
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                 (None, None, None)               &#39;gcn_layer[0][1]&#39;]              
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                )                                                                 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                                                                                  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> gcn_layer_2 (GCNLayer)         ((None, None, 100),  10000       [&#39;gcn_layer_1[0][0]&#39;,            
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                 (None, None, None)               &#39;gcn_layer_1[0][1]&#39;]            
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                )                                                                 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                                                                                  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> gcn_layer_3 (GCNLayer)         ((None, None, 100),  10000       [&#39;gcn_layer_2[0][0]&#39;,            
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                 (None, None, None)               &#39;gcn_layer_2[0][1]&#39;]            
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                )                                                                 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                                                                                  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> GRLayer (GRLayer)              (None, 100)          0           [&#39;gcn_layer_3[0][0]&#39;,            
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                                                  &#39;gcn_layer_3[0][1]&#39;]            
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                                                                                  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> dense (Dense)                  (None, 256)          25856       [&#39;GRLayer[0][0]&#39;]                
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                                                                                  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> dense_1 (Dense)                (None, 1)            257         [&#39;dense[0][0]&#39;]                  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                                                                                  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>==================================================================================================
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Total params: 66,113
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Trainable params: 66,113
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Non-trainable params: 0
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>__________________________________________________________________________________________________
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def gen_data():
    for i in range(len(hivdata)):
        graph = gen_smiles2graph(hivdata.smiles[i])
        activity = hivdata.HIV_active[i]
        yield graph, activity


data = tf.data.Dataset.from_generator(
    gen_data,
    output_types=((tf.float32, tf.float32), tf.float32),
    output_shapes=(
        (tf.TensorShape([None, 100]), tf.TensorShape([None, None])),
        tf.TensorShape([]),
    ),
)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>N = len(hivdata)
split = int(0.1 * N)
test_data = data.take(split)
nontest = data.skip(split)
val_data, train_data = nontest.take(split), nontest.skip(split).shuffle(1000)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>class_weight = {0: 1.0, 1: 30.0}  # to account for class imbalance
result = gcnmodel.fit(
    train_data.batch(128),
    validation_data=val_data.batch(128),
    epochs=30,
    verbose=0,
    class_weight=class_weight,
)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(8, 4))
ax1.plot(result.history[&quot;loss&quot;], label=&quot;training&quot;)
ax1.plot(result.history[&quot;val_loss&quot;], label=&quot;validation&quot;)
ax1.legend()
ax1.set_xlabel(&quot;Epoch&quot;)
ax1.set_ylabel(&quot;Loss&quot;)

ax2.plot(result.history[&quot;accuracy&quot;], label=&quot;training&quot;)
ax2.plot(result.history[&quot;val_accuracy&quot;], label=&quot;validation&quot;)
ax2.legend()
ax2.set_xlabel(&quot;Epoch&quot;)
ax2.set_ylabel(&quot;Accuracy&quot;)
fig.tight_layout()
fig.savefig(&quot;gnn-loss-acc.png&quot;, dpi=180)
fig.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/dc6140c00631dbed5d68a26dcde05089f2c517aafd80bd999542cf34e40a45e0.png" src="../_images/dc6140c00631dbed5d68a26dcde05089f2c517aafd80bd999542cf34e40a45e0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from sklearn.metrics import roc_curve
from sklearn.metrics import auc

prediction = []
test_y = []

for x, y in test_data.as_numpy_iterator():
    yhat = gcnmodel((x[0][np.newaxis, ...], x[1][np.newaxis, ...]))
    prediction.append(yhat.numpy())
    test_y.append(y)

prediction = np.array(prediction).flatten()
test_y = np.array(test_y)

fpr_keras, tpr_keras, thresholds_keras = roc_curve(test_y, prediction)
auc_keras = auc(fpr_keras, tpr_keras)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plt.figure(figsize=(6, 4), dpi=100)
plt.plot(fpr_keras, tpr_keras, label=&quot;AUC = {:.3f}&quot;.format(auc_keras))
plt.plot([0, 1], [0, 1], linestyle=&quot;--&quot;)
plt.xlabel(&quot;True Positive Rate&quot;)
plt.ylabel(&quot;False Positive Rate&quot;)
plt.legend()
plt.savefig(&quot;gnn-roc.png&quot;, dpi=300)
plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1b637c42451715a07a9cabb30524cf17298bb76d17e24a6e539da05addde10ca.png" src="../_images/1b637c42451715a07a9cabb30524cf17298bb76d17e24a6e539da05addde10ca.png" />
</div>
</div>
<section id="cf-explanation">
<h2>CF explanation<a class="headerlink" href="#cf-explanation" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>The following example find CFs for a given molecule where the HIV activity is zero.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def predictor_function(smiles, selfies):
    # print(&#39;inut:&#39;,smiles)
    labels = []
    for sml in smiles:
        nodes, adj_mat = gen_smiles2graph(sml)
        pred = gcnmodel((nodes[np.newaxis, ...], adj_mat[np.newaxis, ...])).numpy()
        labels.append(pred)

    labels = np.array(labels).flatten()
    bin_labels = np.where(labels &gt; 0.5, np.ones(len(labels)), np.zeros(len(labels)))
    target_act = np.zeros(len(labels))
    return abs(bin_labels - target_act).astype(bool)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>basic = exmol.get_basic_alphabet()
stoned_kwargs = {&quot;num_samples&quot;: 1500, &quot;alphabet&quot;: basic, &quot;max_mutations&quot;: 2}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>example_base = &quot;C=CCN(CC=C)C(=O)Nc1ccc(C(=O)NN=Cc2cccc(OC)c2OC)cc1&quot;
space = exmol.sample_space(
    example_base,
    predictor_function,
    stoned_kwargs={&quot;num_samples&quot;: 1500, &quot;alphabet&quot;: basic, &quot;max_mutations&quot;: 2},
    quiet=True,
)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>exps = exmol.cf_explain(space)
fkw = {&quot;figsize&quot;: (8, 6)}
mpl.rc(&quot;axes&quot;, titlesize=12)
exmol.plot_cf(exps, figure_kwargs=fkw, mol_size=(450, 400), nrows=1)
plt.savefig(&quot;gnn-simple.png&quot;, dpi=180)
svg = exmol.insert_svg(exps, mol_fontsize=16)
with open(&quot;gnn-simple.svg&quot;, &quot;w&quot;) as f:
    f.write(svg)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/6def42a0a67fdaa79235b5ce04afcb16be886eee4d216c78dcc0ad0f074ee22f.png" src="../_images/6def42a0a67fdaa79235b5ce04afcb16be886eee4d216c78dcc0ad0f074ee22f.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>font = {&quot;family&quot;: &quot;normal&quot;, &quot;weight&quot;: &quot;normal&quot;, &quot;size&quot;: 22}
exmol.plot_space(
    space,
    exps,
    figure_kwargs=fkw,
    mol_size=(300, 200),
    offset=0,
    cartoon=True,
    rasterized=True,
)
plt.scatter([], [], label=&quot;Counterfactual&quot;, s=150, color=plt.get_cmap(&quot;viridis&quot;)(1.0))
plt.scatter([], [], label=&quot;Same Class&quot;, s=150, color=plt.get_cmap(&quot;viridis&quot;)(0.0))
plt.legend(fontsize=22)
plt.tight_layout()
svg = exmol.insert_svg(exps, mol_fontsize=16)
with open(&quot;gnn-space.svg&quot;, &quot;w&quot;) as f:
    f.write(svg)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/fd894cef97abce44dfa36e68665ba05328812d662f137df0ad3d92aba1e8b89a.png" src="../_images/fd894cef97abce44dfa36e68665ba05328812d662f137df0ad3d92aba1e8b89a.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>exps = exmol.cf_explain(space, nmols=19)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fkw = {&quot;figsize&quot;: (12, 10)}
mpl.rc(&quot;axes&quot;, titlesize=10)
exmol.plot_cf(
    exps, figure_kwargs=fkw, mol_size=(450, 400), mol_fontsize=26, nrows=4, ncols=5
)
plt.savefig(&quot;gnn-simple-20.png&quot;, bbox_inches=&quot;tight&quot;, dpi=300)
svg = exmol.insert_svg(exps, mol_fontsize=14)
with open(&quot;gnn-simple-20.svg&quot;, &quot;w&quot;) as f:
    f.write(svg)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b2803ff0c5469f4d623775fb8f3f655533d98145d9c444d52c2a817e97c1667f.png" src="../_images/b2803ff0c5469f4d623775fb8f3f655533d98145d9c444d52c2a817e97c1667f.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>fkw = {&quot;figsize&quot;: (8, 6)}
font = {&quot;family&quot;: &quot;normal&quot;, &quot;weight&quot;: &quot;normal&quot;, &quot;size&quot;: 22}

exmol.plot_space(space, exps, figure_kwargs=fkw, mol_size=(350, 300), mol_fontsize=22)
plt.scatter([], [], label=&quot;Same Label&quot;, s=150, color=plt.get_cmap(&quot;viridis&quot;)(1.0))
plt.scatter([], [], label=&quot;Counterfactual&quot;, s=150, color=plt.get_cmap(&quot;viridis&quot;)(0.0))
plt.legend(fontsize=22)
plt.savefig(&quot;gnn-space.png&quot;, bbox_inches=&quot;tight&quot;, dpi=180)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/446c5cc0effe31d644c9de14139743364e65eb81390a6a8792c9bedbaf551aa3.png" src="../_images/446c5cc0effe31d644c9de14139743364e65eb81390a6a8792c9bedbaf551aa3.png" />
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="RF.html" class="btn btn-neutral float-left" title="MMACE Paper: Random Forest for Blood-Brain Barrier" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Solubility-RNN.html" class="btn btn-neutral float-right" title="MMACE Paper: Recurrent Neural Network for Predicting Solubility" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Geemi Wellawatte, Andrew D White.
      <span class="lastupdated">Last updated on True.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>