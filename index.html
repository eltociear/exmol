<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Getting Started &mdash; exmol  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Change Log" href="changelog.html" />
    <link rel="prev" title="exmol" href="toc.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="toc.html" class="icon icon-home"> exmol
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#install">Install</a></li>
<li class="toctree-l2"><a class="reference internal" href="#counterfactual-generation">Counterfactual Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#usage">Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#chemical-space">Chemical Space</a></li>
<li class="toctree-l2"><a class="reference internal" href="#svg">SVG</a></li>
<li class="toctree-l2"><a class="reference internal" href="#api-and-docs">API and Docs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#developing">Developing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#citation">Citation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="toc.html">exmol</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="toc.html" class="icon icon-home"></a> &raquo;</li>
      <li>Getting Started</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/index.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="getting-started">
<h1>Getting Started<a class="headerlink" href="#getting-started" title="Permalink to this headline"></a></h1>
<p><a class="reference external" href="https://github.com/ur-whitelab/exmol"><img alt="GitHub" src="https://img.shields.io/badge/github-%23121011.svg?style=for-the-badge&amp;logo=github&amp;logoColor=white" /></a>
<a class="reference external" href="https://github.com/ur-whitelab/exmol"><img alt="tests" src="https://github.com/ur-whitelab/exmol/actions/workflows/tests.yml/badge.svg" /></a> <a class="reference external" href="https://github.com/ur-whitelab/exmol"><img alt="paper" src="https://github.com/ur-whitelab/exmol/actions/workflows/paper.yml/badge.svg" /></a> <a class="reference external" href="https://ur-whitelab.github.io/exmol/"><img alt="docs" src="https://github.com/ur-whitelab/exmol/actions/workflows/docs.yml/badge.svg" /></a>
<a class="reference external" href="https://badge.fury.io/py/exmol"><img alt="PyPI version" src="https://badge.fury.io/py/exmol.svg" /></a>
<a class="reference external" href="https://lbesson.mit-license.org/"><img alt="MIT license" src="https://img.shields.io/badge/License-MIT-blue.svg" /></a></p>
<p><code class="docutils literal notranslate"><span class="pre">exmol</span></code> is a package to explain black-box predictions of molecules. The package uses model agnostic explanations to help users understand why a molecule is predicted to have a property.</p>
<section id="install">
<h2>Install<a class="headerlink" href="#install" title="Permalink to this headline"></a></h2>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>pip install exmol
</pre></div>
</div>
</section>
<section id="counterfactual-generation">
<h2>Counterfactual Generation<a class="headerlink" href="#counterfactual-generation" title="Permalink to this headline"></a></h2>
<p>Our package implements the Model Agnostic Counterfactual Compounds with STONED to generate counterfactuals.
A counterfactual can explain a prediction by showing what would have to change in the molecule to change its predicted class. Here is an eample of a counterfactual:</p>
<blockquote>
<div><p>This package is not popular. If the package had a logo, it would be popular.</p>
</div></blockquote>
<p>In addition to having a changed prediction, a molecular counterfactual must be similar to its base molecule as much as possible. Here is an example of a molecular counterfactual:</p>
<img alt="counterfactual demo" src="https://raw.githubusercontent.com/ur-whitelab/exmol/main/paper/svg_figs/counterfactual.png" width="400">
<p>The counterfactual shows that if the carboxylic acid were an ester, the molecule would be active. It is up to the user to translate this set of structures into a meaningful sentence.</p>
</section>
<section id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline"></a></h2>
<p>Let’s assume you have a deep learning model <code class="docutils literal notranslate"><span class="pre">my_model(s)</span></code> that takes in one SMILES string and outputs a predicted binary class.
To generate counterfactuals, we need to wrap our function so that it can take both SMILES and SELFIES, but
it only needs to use one.</p>
<p>We first expand chemical space around the prediction of interest</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">exmol</span>

<span class="c1"># mol of interest</span>
<span class="n">base</span> <span class="o">=</span> <span class="s1">&#39;Cc1onc(-c2ccccc2Cl)c1C(=O)NC1C(=O)N2C1SC(C)(C)C2C(=O)O&#39;</span>

<span class="n">samples</span> <span class="o">=</span> <span class="n">exmol</span><span class="o">.</span><span class="n">sample_space</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">smi</span><span class="p">,</span> <span class="n">sel</span><span class="p">:</span> <span class="n">my_model</span><span class="p">(</span><span class="n">smi</span><span class="p">),</span> <span class="n">batched</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>Here we use a <code class="docutils literal notranslate"><span class="pre">lambda</span></code> to wrap our function and indicate our function can only take one SMILES string, not a list of them with <code class="docutils literal notranslate"><span class="pre">batched=False</span></code>.
Now we select counterfactuals from that space and plot them.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">cfs</span> <span class="o">=</span> <span class="n">exmol</span><span class="o">.</span><span class="n">cf_explain</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
<span class="n">exmol</span><span class="o">.</span><span class="n">plot_cf</span><span class="p">(</span><span class="n">cfs</span><span class="p">)</span>
</pre></div>
</div>
<img alt="set of counterfactuals" src="https://raw.githubusercontent.com/ur-whitelab/exmol/main/paper/svg_figs/rf-simple.png" width="500">
<p>We can also plot the space around the counterfactual. This is computed via PCA of the affinity matrix – the similarity with the base molecule.
Due to how similarity is calculated, the base is going to be the farthest from all other molecules. Thus your base should fall on the left (or right) extreme of your plot.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">cfs</span> <span class="o">=</span> <span class="n">exmol</span><span class="o">.</span><span class="n">cf_explain</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
<span class="n">exmol</span><span class="o">.</span><span class="n">plot_space</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">cfs</span><span class="p">)</span>
</pre></div>
</div>
<img alt="chemical space" src="https://raw.githubusercontent.com/ur-whitelab/exmol/main/paper/svg_figs/rf-space.png" width="600">
<p>Each counterfactual is a Python <code class="docutils literal notranslate"><span class="pre">dataclass</span></code> with information allowing it to be used in your own analysis:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">cfs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="s1">&#39;smiles&#39;</span><span class="p">:</span> <span class="s1">&#39;Cc1onc(-c2ccccc2Cl)c1C(=O)NC1C(=O)N2C1SC(C)(C)C2C&#39;</span><span class="p">,</span>
<span class="s1">&#39;selfies&#39;</span><span class="p">:</span> <span class="s1">&#39;[C][C][O][N][=C][Branch1_1][Branch2_3][C][=C][C][=C][C][=C][Ring1][Branch1_2][Cl][C]</span>
            <span class="p">[</span><span class="n">Expl</span><span class="o">=</span><span class="n">Ring1</span><span class="p">][</span><span class="n">N</span><span class="p">][</span><span class="n">C</span><span class="p">][</span><span class="n">Branch1_2</span><span class="p">][</span><span class="n">C</span><span class="p">][</span><span class="o">=</span><span class="n">O</span><span class="p">][</span><span class="n">N</span><span class="p">][</span><span class="n">C</span><span class="p">][</span><span class="n">C</span><span class="p">][</span><span class="n">Branch1_2</span><span class="p">][</span><span class="n">C</span><span class="p">][</span><span class="o">=</span><span class="n">O</span><span class="p">][</span><span class="n">N</span><span class="p">][</span><span class="n">C</span><span class="p">][</span><span class="n">Ring1</span><span class="p">][</span><span class="n">Branch1_1</span><span class="p">][</span><span class="n">S</span><span class="p">][</span><span class="n">C</span><span class="p">]</span>
            <span class="p">[</span><span class="n">Branch1_1</span><span class="p">][</span><span class="n">C</span><span class="p">][</span><span class="n">C</span><span class="p">][</span><span class="n">Branch1_1</span><span class="p">][</span><span class="n">C</span><span class="p">][</span><span class="n">C</span><span class="p">][</span><span class="n">C</span><span class="p">][</span><span class="n">Ring1</span><span class="p">][</span><span class="n">Branch1_3</span><span class="p">][</span><span class="n">C</span><span class="p">]</span><span class="s1">&#39;,</span>
<span class="s1">&#39;similarity&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
<span class="s1">&#39;yhat&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="mi">1813</span><span class="p">,</span>
<span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">7.8032394</span> <span class="p">,</span>  <span class="mf">0.51781263</span><span class="p">]),</span>
<span class="s1">&#39;is_origin&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<span class="s1">&#39;cluster&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Counterfactual 1&#39;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="chemical-space">
<h2>Chemical Space<a class="headerlink" href="#chemical-space" title="Permalink to this headline"></a></h2>
<p>When calling <code class="docutils literal notranslate"><span class="pre">exmol.sample_space</span></code> you can pass <code class="docutils literal notranslate"><span class="pre">preset=&lt;preset&gt;</span></code>, which can be
one of the following:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">'narrow'</span></code>: Only one change to molecular structure, reduced set of possible bonds/elements</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'medium'</span></code>: Default. One or two changes to molecular structure, reduced set of possible bonds/elements</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'wide'</span></code>: One through five changes to molecular structure, large set of possible bonds/elements</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'chemed'</span></code>: A restrictive set where only pubchem molecules are considered.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'custom'</span></code>: A restrictive set where only molecules provided by the “data” key are considered.</p></li>
</ul>
<p>You can also pass <code class="docutils literal notranslate"><span class="pre">num_samples</span></code> as a “request” for number of samples. You will typically end up with less due to
degenerate molecules. See API for complete description.</p>
</section>
<section id="svg">
<h2>SVG<a class="headerlink" href="#svg" title="Permalink to this headline"></a></h2>
<p>Molecules are by default drawn as PNGs. If you would like to have them drawn as SVGs, call <code class="docutils literal notranslate"><span class="pre">insert_svg</span></code> after calling
<code class="docutils literal notranslate"><span class="pre">plot_space</span></code> or <code class="docutils literal notranslate"><span class="pre">plot_cf</span></code></p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">skunk</span>
<span class="n">exmol</span><span class="o">.</span><span class="n">plot_cf</span><span class="p">(</span><span class="n">exps</span><span class="p">)</span>
<span class="n">svg</span> <span class="o">=</span> <span class="n">exmol</span><span class="o">.</span><span class="n">insert_svg</span><span class="p">(</span><span class="n">exps</span><span class="p">,</span> <span class="n">mol_fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

<span class="c1"># for Jupyter Notebook</span>
<span class="n">skunk</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">svg</span><span class="p">)</span>

<span class="c1"># To save to file</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;myplot.svg&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">svg</span><span class="p">)</span>
</pre></div>
</div>
<p>This is done with the <a class="reference external" href="https://github.com/whitead/skunk">skunk🦨 library</a>.</p>
</section>
<section id="api-and-docs">
<h2>API and Docs<a class="headerlink" href="#api-and-docs" title="Permalink to this headline"></a></h2>
<p><a class="reference external" href="https://ur-whitelab.github.io/exmol/api.html">Read API here</a>. You should also read the paper (see below) for a more exact
description of the methods and implementation.</p>
</section>
<section id="developing">
<h2>Developing<a class="headerlink" href="#developing" title="Permalink to this headline"></a></h2>
<p>This repo uses pre-commit, so after cloning run <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">-r</span> <span class="pre">requirements.txt</span></code> and <code class="docutils literal notranslate"><span class="pre">pre-commit</span> <span class="pre">install</span></code> prior to committing.</p>
</section>
<section id="citation">
<h2>Citation<a class="headerlink" href="#citation" title="Permalink to this headline"></a></h2>
<p>Please cite <a class="reference external" href="https://pubs.rsc.org/en/content/articlelanding/2022/sc/d1sc05259d#!divAbstract">Wellawatte et al.</a></p>
<div class="highlight-bibtex notranslate"><div class="highlight"><pre><span></span><span class="nc">@Article</span><span class="p">{</span><span class="nl">wellawatte_seshadri_white_2021</span><span class="p">,</span><span class="w"></span>
<span class="na">author</span><span class="w"> </span><span class="p">=</span><span class="s">&quot;Wellawatte, Geemi P. and Seshadri, Aditi and White, Andrew D.&quot;</span><span class="p">,</span><span class="w"></span>
<span class="na">title</span><span class="w">  </span><span class="p">=</span><span class="s">&quot;Model agnostic generation of counterfactual explanations for molecules&quot;</span><span class="p">,</span><span class="w"></span>
<span class="na">journal</span><span class="w">  </span><span class="p">=</span><span class="s">&quot;Chem. Sci.&quot;</span><span class="p">,</span><span class="w"></span>
<span class="na">year</span><span class="w">  </span><span class="p">=</span><span class="s">&quot;2022&quot;</span><span class="p">,</span><span class="w"></span>
<span class="na">pages</span><span class="w">  </span><span class="p">=</span><span class="s">&quot;-&quot;</span><span class="p">,</span><span class="w"></span>
<span class="na">publisher</span><span class="w">  </span><span class="p">=</span><span class="s">&quot;The Royal Society of Chemistry&quot;</span><span class="p">,</span><span class="w"></span>
<span class="na">doi</span><span class="w">  </span><span class="p">=</span><span class="s">&quot;10.1039/D1SC05259D&quot;</span><span class="p">,</span><span class="w"></span>
<span class="na">url</span><span class="w">  </span><span class="p">=</span><span class="s">&quot;http://dx.doi.org/10.1039/D1SC05259D&quot;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="toc.html" class="btn btn-neutral float-left" title="exmol" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="changelog.html" class="btn btn-neutral float-right" title="Change Log" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Geemi Wellawatte, Andrew D White.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>